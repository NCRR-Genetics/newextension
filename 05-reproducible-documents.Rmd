# Analytically reproducible documents {#reproducible-documents}

![](https://img.shields.io/badge/document%20status-in%20progress-orange?style=flat-square)

> When in RStudio, quickly jump to this page using `r3::open_reproducible_documents()`.

**Session objectives**:

1. Learn what a reproducible document is,
how R Markdown achieves being reproducible, 
and why it can save you time and effort
1. Write and use R code within a document,
so that it will automatically insert the R output into the final document.
1. Learn about and use Markdown formatting and syntax for writing documents.
1. Learn about and create different document types like HTML 
or Word from an R Markdown document.

## Why try to be reproducible?

**Take about 5 min to read over this section**.

Both reproducibility and replicability are cornerstones for doing rigorous 
and sound science. 
As we've learned, 
reproducibility in science is fairly lacking, 
which this course aims to fill. 
But being reproducible isn't just about doing better science, it can also:

1. Make you much more efficient and productive, as less time is spent between
coding and putting your results in the document (no need for copy and pasting).
1. Make you more confident in your results, 
since what you report 
and show as figures or tables will be exactly what you get from your analysis. 
Again, no copying and pasting required!

Hopefully by the end of this session you'll try to start using R Markdown files
for writing your manuscripts and other technical documents. Believe us, it can
save soooo much time in the end, after you've learned how to incorporate text
with R code, and make your analysis and work more reproducible. Plus you can create
some beautifully formatting reports, waaayyyy more easily than you can if you did
it all in Word. As a bonus, switching between citation formats for different
journals is a breeze.

## Creating an R Markdown file

**Take about 5 min to read over the next few paragraphs**.

R Markdown is a file format (a plain text format like R scripts or `.csv` files)
that allows you to be more reproducible in your analysis 
and to be more productive in general in your work.
R Markdown is a extension of [Markdown][pandoc] that integrates R code 
with written text (as Markdown formatting).

So what is Markdown? 
It is a [markup syntax] and formatting tool, like HTML,
that allows you write a document in plain text
to then be able to convert to a vast range of other document types,
e.g. HTML, PDF, Word documents, slides, posters, websites.
In fact, this website is built from R and Markdown! 
(Plus other things like HTML.) 
The Markdown used in R Markdown is based on [pandoc] 
("pan" means all and "doc" means document, so "all documents"), 
a very powerful, popular, and well-maintained software tool for document conversion. 
But, we'll get to Markdown more a bit later.
For now we're going to focus on the main reason to use it:
for incorporating R code and output into a document!
By using R code in a document, 
you can have a seamless integration between document writing and analysis.

Why would you use this? There are many reasons, some of them being:

- There is less time between exploring a new dataset or analysis
and sharing your findings with collaborators,
because the writing and documenting is woven in with your R analysis code.
- If you finish an analysis and produce a report, 
but later find out there are problems with the data or you get new data,
updating your report is as easy as clicking a button to regenerate it.
- How you got and show your results is based on the exact sequence of steps
given in your R Markdown document,
so showing or learning from others on how the analysis is done is easy 
because the *how* is explicitly shown in the document.

[markup syntax]: https://en.wikipedia.org/wiki/Markup_language
[pandoc]: https://pandoc.org/index.html

**Let's go over this together**.

Ok, let's create and save an R Markdown file. 
Go to `File -> New File -> R Markdown`.
A dialog box will pop up.
Type in `Reproducible documents` in the title section 
and your name in the author section. 
Choose HTML as the output format.
Then save this file as `rmarkdown-session.Rmd` in the `doc/` folder.

TODO: Video of making R Markdown file.

We now have an R Markdown file.
Inside the file is some text that gives a brief overview of how to use it.
For now, let's ignore the text.

## YAML header/metadata

You may see 
Most Markdown documents (especially for R Markdown) include [YAML] metadata at
the top of the document, surrounded by `---` on the top and bottom. The YAML
contains metadata and options for the entire document. For instance, the title
or author but also the output format you want to use, such as Word, HTML, or PDF
(if you want to create a beautiful PDF, you need to install the R package
[tinytex]). There are many more output formats, but these are the most common.

[YAML]: https://bookdown.org/yihui/rmarkdown/html-document.html
[tinytex]: https://yihui.name/tinytex/

```yaml
---
title: "Document title"
author: Your Name
output: word_document
---
```

There are additional options you can set in the output field, which we will show
later below.

- YAML header

- Generating the document
    - HTML
    - Word
    - Comment about PDF


## Exercise: Create another R Markdown document. 

Time: 10 min

1. Create another R Markdown document using RStudio's interface.
    - Write the title as "Trying out R Markdown".
    - Choose "HTML" as the document type.
1. Save the document in the `doc/` folder and name it `another-one.Rmd`.
1. Knit the document with either "Ctrl-Shift-K" 
or with the RStudio "Knit" button.
1. Look at the output document, then change the YAML value for the `output:`
key from `html_document` to `word_document`. Knit again.
1. Open the Word file if it hasn't been opened already.

## Inserting R code into the document

- Using R in R Markdown and inserting the output

One of the most powerful and useful features of R Markdown is its ability to
combine text and R code in the same document! 

Insert R code chunk via "Ctrl-Alt-I" or with the menu item "Code -> Insert Chunk".
You should get something that looks like this:

````markdown
`r ''````{r}
 
`r ''````
````

- Code chunks
    - Common options

- Creating a table

 Exercise: Create a table


**NOTE**: Code [chunk labels] should be named without `_`, spaces, or `.` and 
instead should be one word or be separated by `-`. While an error may not 
necessarily occur, there can be some unintended side effects that will cause you
some annoyance without knowing the reason.

[chunk labels]: https://yihui.name/knitr/options/#chunk-options

TODO: Add explanation about `setup` code chunk

````markdown
`r ''````{r setup}
library(tidyverse)
`r ''````
````

````markdown
`r ''````{r}
2 + 2
`r ''````
````

```{r}
2 + 2
```

Or just print out a number to the document:

````markdown
`r ''````{r}
cor(NHANES$Height, NHANES$Weight)
`r ''````
````

```{r}
cor(iris$Sepal.Length, iris$Sepal.Width)
```

You can also create tables by using the `kable()` function from the knitr package:

````markdown
`r ''````{r mean-bmi-table}
NHANES %>% 
    select(SurveyYr, BMI, Diabetes) %>% 
    group_by(SurveyYr, Diabetes) %>% 
    summarise(MeanBMI = mean(BMI, na.rm = TRUE)) %>% 
    spread(SurveyYr, MeanBMI) %>% 
    knitr::kable(caption = "Table caption here")
`r ''````
````

```{r mean-bmi-table, echo=FALSE}
library(knitr)
NHANES %>% 
    select(SurveyYr, BMI, Diabetes) %>% 
    mutate_at(vars(Diabetes), forcats::fct_explicit_na) %>% 
    group_by(SurveyYr, Diabetes) %>% 
    summarise(MeanBMI = round(mean(BMI, na.rm = TRUE), 2)) %>% 
    spread(SurveyYr, MeanBMI) %>% 
    kable(caption = "Table caption here")
```

If you want a code chunk to be invisible, code chunks to be 

````markdown
`r ''````{r, echo=FALSE}
2 + 2
`r ''````
````

```{r, echo=FALSE}
2 + 2
```

````markdown
`r ''````{r setup}
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE)
`r ''````
````

## Formatting text with Markdown syntax

Formatting text in Markdown is done using characters that are considered "special"
and act like commands.
So these special characters indicate what text is bolded,
what is a header, what is a list, and so on.
Almost every feature you need to write a scientific document is available in Markdown,
though not all.
If you can't get Markdown to do what you want,
my suggestion would be to try to fit your writing around Markdown, 
rather than force or fight Markdown to do something it wasn't designed to do. 
You might actually find that the simpler Markdown approach is easier 
than what you wanted or were thinking of doing,
and can actually do quite a lot with the basics that Markdown can do.

### Headers 

Creating headers (like chapters or sections) is done by using one 
or more `#` at the beginning of a line 
and should always be preceded and followed by an empty line: 

```markdown
# Header 1

Paragraph.

## Header 2

Paragraph.

### Header 3

Paragraph.
```

### General text formatting

- `**bold**` gives **bold**. 
- `*italics*` gives *italics*.
- `super^script^` gives super^script^.
- `sub~script~` gives sub~script~.

### Lists

Lists are created by adding either `- ` or `1.` to the beginning of a line
and an empty line must be at the start and end of the list.

For unnumbered lists, it looks like:

```markdown
- item 1
- item 2
- item 3
```

which gives...

- item 1
- item 2
- item 3

And numbered list look like:

```markdown
1. item 1
2. item 2
3. item 3
```

which gives...

1. item 1
2. item 2
3. item 3

### Block quotes

Block quotes are used when you want to emphasize a block of text,
usually for quoting someone. 
You create a block quote by putting a `>` at the beginning of the line,
and as with the lists and headers, 
needs empty lines before and after the text.
So it looks like:

```markdown
> Block quote 
```

which gives...

> Block quote 

### Adding footnotes

Footnotes are added by enclosing a number or word in square brackets (`[]`)
and beginning with an uptick (`^`). It looks like:

```markdown
Footnote[^1] or this[^note].

[^1]: Footnote content
[^note]: Another footnote
```

which gives...

Footnote[^1] or this[^note].

[^1]: Footnote content
[^note]: Another footnote

### Adding links to websites

Including a link to a website in your document is done by surrounding the link text
with square brackets (`[]`) followed by the link URL in brackets (`()`).
There must not be any space between the square brackets 
and the regular brackets (should look like `[]()`).

```markdown
[Link](https://google.com)
```

which gives...

[Link](https://google.com)

### Inserting (simple) tables

While you can insert tables using Markdown too, 
it isn't recommended to do that for complicated or large tables.
Tables are created by separating columns with `|`,
with the table header being separated by a line that looks like `|:--|`.
A simple example is:

```
|   | Fun | Serious |
|:--|----:|--------:|
| **Happy** | 1234 | 5678 |
| **Sad** | 123 | 456 |
```

gives...

|   | Fun | Serious |
|:--|:---:|:-------:|
| **Happy** | 1234 | 5678 |
| **Sad** | 123 | 456 |

The `|---:|` or `|:---|` tell the table to left-align or right-align the values
in the column. Center-align is `|:----:|`.

So you can probably imagine,
doing this for larger or even slightly more complicated tables is not practical.
A good alternative approach is to create the table in a spreadsheet,
importing that table into R within a code chunk,
and using `knitr::kable()` to create the table after that.

### Inline R code

R Markdown also allows you to including numbers 
(or other output) directly into a paragraph.
For instance, if you want to add a mean into some text,
it would look like:

> The mean of BMI is &#96;r round(mean(NHANES$BMI, na.rm = TRUE), 2)&#96;.

which gives...

The mean of BMI is `r round(mean(NHANES$BMI, na.rm = TRUE), 2)`.

But note that using inline R code can *only* insert a *single* number 
or character value, nothing more.

## Exercise: Practice using Markdown for writing text

Time: 10 min

1. Create three level 1 headers (`#`), called "Intro", "Methods and Results", "Discussion".
1. Create a level 2 header (`##`) under "Methods and Results" called "Analysis".
1. Write one random short sentences under each header. 
Bold (`**word**`) one word in each and italicize (`*word*`) another.
1. Include an inline R code to calculate 10 divided by 2 in the "Analysis" section.
1. Play around with adding some lists, tables, or anything else.

## Inserting figures, as files or from R code

You can insert plots by including a
code chunk, like the one below. The options added to the code chunk tell it to
add a caption, to set the height and width of the figure, and to prevent the code
chunk from showing up in the final document (`echo=FALSE`). The `bmi-plot` label is
the name of the code chunk (which you can see in the "Document Outline", found
using `Ctrl-Shift-O`, if you have the options set in the `Tools -> Global
Options -> R Markdown`).

````markdown
`r ''````{r bmi-plot, fig.cap="Add your figure title here.", fig.height=8, fig.width=8, echo=FALSE}
ggplot(NHANES, aes(x = Height, fill = Gender)) +
    geom_density(alpha = 0.4) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_minimal() +
    theme(legend.position = c(0.2, 0.85))
`r ''````
````

(ref:insert-plot) Add your figure title here.

```{r bmi-plot, fig.cap="(ref:insert-plot)", fig.height=8, fig.width=8, echo=FALSE}
ggplot(NHANES, aes(x = Height, fill = Gender)) +
    geom_density(alpha = 0.4) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_minimal() +
    theme(legend.position = c(0.2, 0.85))
```

- Inserting graphs
    - From R and from image file
    

A png, jpeg, or pdf image can be attached by doing (here, use an image of your own):

```markdown
![image caption](/img/code-sharing-steps.png)
```

gives...

TODO: Add image.

image caption /img/code-sharing-steps.png

*Note*: Can also include links to images from the Internet, as a URL link.


## Exercise: Insert a graph using R code


## Making your report prettier

Read this, won't go over it.

This part mostly applies to HTML-based and PDF[^tinytex] outputs, since
programmatically modifying or setting templates Word documents is rather
difficult[^md-to-word]. Knitting to PDF requires that you install LaTeX using
the [tinytex](https://yihui.name/tinytex/r/) R package.
After you install LaTeX you can create truly beautifully typeset PDF documents,
however installing LaTeX can often be quite difficult. So we won't be doing it.
Changing broad features of a document can be done by setting the
"theme" of the document. Add an option in the YAML metadata like:

```yaml
---
title: "My report"
output:
    html_document:
        theme: sandstone
---
```

Check out the R Markdown [documentation] for more types of themes you can use
for HTML documents, and advanced topics such as parameterized R Markdown documents. 
Most of the [Bootswatch] themes are available for use in R
Markdown to HTML conversion.

[documentation]: https://bookdown.org/yihui/rmarkdown/html-document.html#appearance-and-style
[Bootswatch]: https://bootswatch.com/3/

[^tinytex]: Knitting to PDF will require that you install LaTeX using the [tinytex](https://yihui.name/tinytex/r/) R package. After you install LaTeX you can create truly beautifully typeset PDF documents.

[^md-to-word]: If you really want to do it, the best way is to create your template in the `.odt`, and then convert to `.docx`. [Here](https://github.com/andrewheiss/Global-Pandoc-files) is a good place to start. 

## Collaborating on Rmd document

Read but not cover

    - Create multiple documents named differently
    - At end put all pieces together into one document and delete the others
        - Knitting at end to make sure it looks good.
        - Delegate one person to do that

## Final exercise: Group work

Time: 30 min

It's now time to start putting things together as a report 
and to present on it later in the afternoon.

- As a team, 
complete item 7 and its subtasks in the [group assignment](assignment.html)
(to jump quickly to the assignment, 
run `r3::open_assignment()` in the RStudio Console).
- Distribute the tasks so each team member is (mostly) doing something different.
    - Create one R Markdown file for each team member,
    and each person works on their own file.
    Later this file will be merged into the final report.
- Frequently use the "Git workflow": 
Add, commit, push, and pull the changes you've made.
    - You'll likely deal with merge conflicts, 
    which is a good chance to practice with Git more.
- Try to "knit" your document to HTML often, 
to make sure the analysis is reproducible.
    - **Note**: For now, *do not* add and commit the HTML report.

Once you as a team are happy with the report, figures, and tables,
make sure that everyone does a final add-commit-push to your GitHub repository.
Then, designate someone to pull from GitHub, 
merge each R Markdown file into a single `report.Rmd` file in the `doc/` folder,
and knit the `.Rmd` document to make sure it knits correctly. 
Then add-commit-push the HTML report to GitHub.
You should now be ready to present your report!
